<?php

namespace App\Http\Controllers\Front;

use Illuminate\Http\Request;
use App\Http\Controllers\RSController;

class NewsController extends RSController
{
    /**
     * Display a listing of the resource.
     * @return \Illuminate\Http\Response
     */
    public function index()
    {
        // Берем все новости и кидаем их в пагинацию

        $news = Model('publication')
                  ->where('pubdate', '<=', date('Y-m-d H:i:s'))
                  ->orderBy('pubdate', 'desc')
                  ->paginate(config('public.pagination.news'));


        return $this->make_view('news.index', compact('news'));
    }

    /**
     * Display the specified resource.
     * @return \Illuminate\Http\Response
     */
    public function view()
    {
      $tag_ids = explode(',', $this->fields->tag_ids);
      $tags = Model('tag')->whereIn('node_id', $tag_ids)->get();
      $random_tag = Model('tag')->whereIn('node_id', $tag_ids)->inRandomOrder()->first();

      $comments= Model('comment')->where('parent_id', '=', $this->fields->node_id)->latest()->get();
      foreach($comments as $k =>$comment)
      {
        $comments[$k]['user_name'] = Model('user')->where('node_id', $comment->user_id)->first()->name;
      }

      $similar_publications = Model('new')
                                ->where('tag_ids', 'Like', '%,'.$random_tag->node_id.'%')
                                ->where('node_id', '!=', $this->fields->node_id)
                                ->where('pubdate', '<=', date('Y-m-d H:i:s'))
                                ->orderBy('pubdate', 'desc')
                                ->limit(3)
                                ->get();

      return $this->make_view('publications.view', compact('comments', 'tags', 'similar_publications'));
    }

}
